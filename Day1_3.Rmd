---
title: "2021 경제인문사회연구회 맞춤형"
output: 
  html_document
---

# 데이터 종류에 따른 분석 기법

## 1. 데이터형, 분석 기법, R 함수

> 80%의 실제 문제는 20% 정도의 통계 기법으로 처리할 수 있다

|데이터형 |	분석 기법 |	R함수|
|:--|  :---| :------ |
|0. 모든데이터 	|데이터 내용, 구조 파악 	|str(), head(), tail(), dim()|
||	요약 통계량| 	summary|
||	단순 시각화| 	plot, pairs|
|1. 연속형 자료 	|분포시각| 	hist, boxplot, density|
||	요약 통계량| 	mean, median|
|2. 범주형 범주형(성공-실패)| 	도수 분포| 	table(), xtabs()|
||	막대도표 |	barplot()|
||	이항검정 |	binom.test()|
|3. 수량형 x, 수량형 y 	|산점도| 	plot()|
||	상관계수 |	cor()|
|4. 범주형 x, 수량형 y 	|병렬상자그림| 	boxplot()|
||	분산분석 	|aov()|
|5. 수량형 x, 범주형(성공-실패) y |	산점도/병렬상자그림| 	plot(), boxplot()|

## 2. 데이터 탐색하기


- 데이터 내용, 구조, 타입을 파악한다.
  
- str, summary, head, tail, dim 등을 사용하여 자료 확인

```{r, warning=F, message=F}
library(dplyr)
mpg <- ggplot2::mpg

head(mpg)
str(mpg)
head(mpg)
tail(mpg)
dim(mpg)

```

- 데이터의 요약 통계량과 결측치가 있는지 summary로 파악한다.

```{r}
summary(mpg)
```

- 무작정 시각화를 해본다. 

    데이터의 관측치가 많을 때는 실행시간이 길으니 샘플링 후 시각화 한다.
    
    데이터의 변수가 10개 이상 많을 대는 10열씩 구분하여 살펴보는 것도 유용하다.

## 3. 연속형 변수의 분석
  
일변량 변수에 대한 통계량 분석은 다음과 같다.

- 데이터 분포의 시각화: 히스토그램, 상자그림, 확률밀도함수 시각화를 통해 분포를 살펴본다.

- ggplot() + geom_{histogram, density}() 함수 추천

```{r, warning=FALSE}
library(ggplot2)
ggplot(data=mpg, aes(x=hwy))+geom_histogram()
ggplot(data=mpg, aes(x=hwy))+geom_boxplot()
ggplot(data=mpg, aes(x=hwy))+geom_density()
```

- 요약 통계량 계산: summary, mean, median, var, sd, mad, quantile 사용

```{r}
summary(mpg$hwy)

c(mean(mpg$hwy), median(mean(mpg$hwy)), var(mpg$hwy), sd(mpg$hwy), mad(mpg$hwy), quantile(mpg$hwy))
```

- 데이터 정규성 검사: qqplot, qqline 함수는 분포가 정규분포와 얼마나 유사한지 검사하는데 사용된다. 

- shapiro.test() 사용

```{r}
qqnorm(mpg$hwy)
qqline(mpg$hwy)

shapiro.test(mpg$hwy)
```

- 이상점 찾아보기: boxplot() 사용

이상점(outliers)는 여러 이유로 다른 관측치와 매우 다른 값을 가진 관측치다. 가장 쉽게 찾을 수 있는 방법은 boxplot을 살펴보는 것이다. boxplot에서 이상점은 [Q1 - 1.5 x IQR, Q3 + 1.5 x IQR] 구간 바깥의 값들이다.

```{r}
boxplot(mpg$hwy)$out
```

- 중심극한정리

중심 극한 정리는 확률 및 통계의 기초 정리입니다. 

중심극한정리는 표본평균의 분포를 다룹니다.

1. 모집단의 분포가 평균이 $\mu$이고 분산이 $\sigma^2$인 정규분포를 따른다면, 표본평균의 분포는 평균이 $\mu$이고 분산이 ${{\sigma^2} \over {n}}$ 인 정규분포를 따른다.

    당연하겠지만 모집단이 정규분포이면 표본평균의 분포는 정규분포를 따르게 됩니다.
    

대부분의 통계에 관한 연구는 **표본에서 구한 통계량**으로 **모집단의 모수**를 추정하는 추론 통계에 관심이 많음.

왜?

>  모집단을 조사하기 위해서는 돈과 시간이 많이 들기 때문에

모평균에 관한 통계적 가설검정을 일표본 t검정, 독립 t검정, 대응 t검정이 있음.

## 통계적 가설검정

통계적 가설검정이란? 귀무가설과 대립가설을 세워 귀무가설에 대해 확인하는 방법을 칭한다.

통계적 가설검정은 법과 같이 `무죄추정의 법칙`에 근거하여 귀무가설에 대해

`증거`를 기준으로 검정한다. 여기에서 사용되는 `증거`를 통계학에서는 `검정통계량`이라 한다.

### 일표본 t 검정

일변량 연속형 자료에 흔하게 사용되는 통계 추정절차는 t-검정이다. 

다음과 같은 단측검정(one-side hypothesis testing)을 시행하고자 한다고 해보자.

$$ H_0 :\mu <=22.9 ~~~vs.~~~ H_1 : \mu>22.9 $$

여기의 검정통계량은

$$T = {{\bar X - \mu} \over {S \over \sqrt n}}$$

이다. 즉 표본평균 $\bar X$와 모평균 $\mu$ 가 가까울수록 검정통계량 T는 0에 가까워짐

검정통계량이 0에 가까울수록, 귀무가설이 맞다

반대로 검정통계량이 0에서 멀어질수록, 귀무가설이 틀리다.

그럼 어디까지를 귀무가설과 동일하다고 볼 것인가?

이를 통계학에서는 `유의수준`이라고 하며 다른말로 `1종 오류`라고 한다.

분석에서는 **유의확률** : *귀무가설이 맞다고 가정했을 때 귀무가설을 지지할 확률* 로 가설 검정한다.

앞의 가설검정은 R의 t.test() 명령으로 간단하게 시행할 수 있다.

```{r}
mu0 <- 22.9

t.test(mpg$hwy, mu = mu0, alternative = "greater")
```

P-value는 0.083이다. 만일 실제 모 평균 고속도로 연비가 22.9라면 우리가 관측한 것 만큼 큰 표본평균값과 t 통계량(t = 1.3877)이 관측될 확률이 8.3%라는 것이다. 따라서 유의수준 $\alpha$ = 0.05 라고 한다면 고속도록 연비가 22.9보다 크다고 결론지을 만한 증거가 충분하지 않다고 할 수 있다.

```{r}

t.test(mpg$hwy)

```

모평균의 95% 신뢰구간은 [22.6, 24.2]도 쉽게 구할 수 있다. 


- 독립 t 검정

서로 다른 2개의 집단의 모평균에 차이가 있는지 가설검정할 때 사용

가장 대표적인 독립 t검정은 예는 남성과 여성의 성적, 키, 몸무게에 평균차이가 있는지 확인

mpg 차량의 전륜과 후륜 자동차의 시내연비에 차이가 있는지 비교한다면??

귀무가설 : 전륜차량의 시내연비와 후륜차량의 시내연비가 같다.

$$H_0 : \mu_{front} = \mu{rear}$$
대립가설 : not $H_0$

이 경우 2개의 데이터를 직접 입력하여 t.test()를 실행시키면 된다.

T 검정통계량은 분산이 같은 경우와 다른 경우에 다르게 계산되므로
```{r, message=F, warning=F}
d1 <- mpg %>% filter(drv %in% c("f","r"))

if(!require(car)) install.packages("car"); library(car)
leveneTest(cty~factor(drv), data=d1)
```

에 대해 등분산 검정을 수행한다.

등분산여부를 검정한 결과 분산이 동일하므로 아래의 코드를 입력한다.

```{r}
t.test(cty~drv, data=d1, var.equal = TRUE)
```

- 대응 t 검정

대응 되는 자료에 대한 검정으로 동일한 집단에 대해 두번 실험이 되어 결과가 짝(paired)을 이루는 경우이다.

자동차의 시내연비와 고속연비 간 차이가 있다.

```{r}
t.test(mpg$cty, mpg$hwy, paired=T)
```


## 4. 범주형 자료 (성공-실패)

- 요약 통계량 계산: table(), xtab() 등이 있다.

- prop.table() 함수는 도수를 상대도수(relative frequncy)로 바꿔준다. table() 함수는 도수 분포를 계산해준다. 

```{r}
set.seed(1606)
n <- 100
p <- 0.7
x <- rbinom(n, 1, p) # 성공률이 70%인 이항분표로 임의의 자료 생성
x <- factor(x, levels = c(0,1), labels = c("yes", "no")) # yes와 no로 입력된 factor 자료 생성
x

table(x)
```

- 시각화: barplot()이 유용하다.

```{r}
barplot(table(x))
ggplot(data=data.frame(x=x), aes(x=x))+ geom_bar()
```

- 가설검정과 신뢰구간: binnorm.test() 함수를 사용하면 ’성공률’에 대한 검정과 신뢰구간을 구할 수 있다.

우리는 실제 ’지지율’이 70%인 것을 알고 있지만, 일단 우리가 그것을 모른다고 가정해보자. 

$$H_0 : p=0.7~~vs.~~H_1:p \ne0.7$$

R에서 binom.test로 쉽게 신뢰구간과 가설검정을 시행할 수 있다.

```{r}
table(x=="yes")
args(binom.test)
binom.test(64, 100, p = .7)
```

전륜차량의 비율이 전체 차량의 50%라고 할 수 있을까? 가설검정을 한다면
```{r}
table(mpg$drv)
binom.test(106, n=103+106+25, p = .5)
```

선거에서 투표율의 비율에 대한 추정시 오차한계를 구할 수 있다. 

$$ p - \hat p \le Z_{\alpha/2} \sqrt{\hat p (1- \hat p) / n} $$

유의수준 0.05에서 $Z_{\alpha/2}=1.96$이고 $\hat p =0.5$ 일때 최대의 분산을 지니므로 

표본 수 n의 크기에 따른 그림을 다음과 같이 그려 볼 수 있다. 

```{r}
curve(1.96 * sqrt(1/(4 * x)), 10, 1000)
```

서로 다른 두 개의 범주형 자료 간 연관성을 분석한다면?

자동차의 구동방식과 실린더 수에 연관이 있을까?

이 경우 교차검정(카이제곱)을 통해 통계적 가설검정을 할 수 있습니다.

사용하는 함수는 chisq.test()입니다.

```{r}
mpg <- data.frame(ggplot2::mpg)

t1 <- table(mpg$drv, mpg$cyl)

chisq.test(t1)
```

## 5. 독립변수와 종속변수

두 변수 사이의 관계를 연구할 때는 각 변수를 설명변수 X와 반응 변수 Y로 구부하는 것이 유용하다. 보통 인과 관계에서 원인이 되는 것으로 믿어지는 변수를 X로, 결과가 되는 변수를 Y로 놓는다.

독립변수 X는 설명변수라고도 불린다. 종속변수 Y는 반응변수라고도 불린다.

### 산점도

두 연속형 변수 X와 Y가 있을 때의 시각화는 산점도가 기본이다.

```{r}
mpg %>% 
  ggplot(aes(cty, hwy)) + geom_jitter() + geom_smooth(method = "lm")
```


### 상관계수

cor() 함수는 상관계수(correlation coefficient)를 계산해준다.

상관계수는 공분산을 각각의 표준편차로 나눈 값으로 자세한 내용은 아래 내용 참고하세요.

![](https://t1.daumcdn.net/cfile/tistory/99C0B2445DF7564614)


상관계수로 분포의 형상을 추측할 때 주의할 점은 개별 자료가 상관계수에 미치는 영향력이 각각 다르다는 점이다. 다음은 Frank Anscombe의 논문에 예시된 자료로 모두 상관계수를 포함한 통계적 특성이 동일하다. 상관계수의 값은 약 0.816이다.

상관계수 세번째와 네번째 자료에서 볼 수 있듯이 나머지 자료의 상관계수가 정확히 1 또는 0인 경우에도 단 하나의 특이값 자료에 의해 전체 상관계수가 크게 달라질 수 있다.

상관계수는 또한 이상치의 영향을 많이 받으므로 로버스트한 방법인 켄달(Kendall)의 $\tau$ (타우)나 스피어맨(Spearman)의 $\rho$(로) 통계량을 계산하는 것도 좋은 방법이다.

```{r}
cor(mpg$cty, mpg$hwy)
cor.test(mpg$cty, mpg$hwy)
```

### 회귀모형

독립변수와 종속변수 간에 높은 상관성이 있는 경우 이에 대한 선형식을 생각해 볼 수 있다.

$$Y = \beta_0 + \beta_1 X + \epsilon, ~~~\epsilon \sim N(0, \sigma^2) $$

하나의 독립변수로 이루어진 모형을 단순 회귀모형(simple regression model)이라고 한다.

lm()과 summary.lm() 함수는 위의 선형 모형을 최소제곱법으로 추정한다. 

```{r}
hwy_lm <- lm(hwy ~ cty, data = mpg)
summary(hwy_lm)
```

새로운 값에 대한 예측은 predict()함수와 newdata를 사용하여 구할 수 있다.
```{r}
predict(hwy_lm, newdata = data.frame(cty = c(10, 20, 30)))
```

이에 대한 자세한 내용은 2일차에 이어서 강의합니다.

## 6. 분산분석

분산분석은 설문이나 실험의 결과가 유의미한지를 판별하는 방법이다. 다시 말하자면, 분산분석은 서로 다른 3개 이상의 집단들 사이에 평균차이가 있는지를 검정하는 것이다.

    여러 정신과 환자들이 상담, 명상, 그리고 바이오 피드백 세 가지 치료법을 시도하려고 한다. 여러분은 이 중에서 다른 치료법보다 나은 치료 방법이 있는지를 알고 싶어 한다.
    한 제조업체는 전구를 만드는 세 가지 공법이 있다. 이 회사는 어떤 방법이 최소 비용으로 효과적으로 제품을 생각하는지 알고 싶다.
    서로 도시별 학생들이 같은 수학능력이 비슷한지 모의시험을 치르려고 한다. 이 때 특수학교가 다른 학교보다 성적이 더 나은지 알고 싶어 한다.

```{r}
mydata3 = read.csv("C:/Users/stats/Documents/R 중급강좌 (통계교육원)/Day1/anova_one_way.csv") # 파일을 불러와 mydata3로 저장
head(mydata3) # 불러온 데이터를 R Studio에서 확인
names(mydata3) # 불러온 데이터에 포함된 변수의 이름을 확인
```

집단한 비교는 상자그림이 가장 알기 쉽습니다.
```{r}
boxplot(birth_rate~ad_layer, data=mydata3) #상자그림을 통해 지역별 차이를 시각적을 확인

library(dplyr)
mydata3 %>% group_by(ad_layer) %>% 
  summarise(n=n(), mean=mean(birth_rate), sd=sd(birth_rate))

info.mydata3<- as.data.frame(mydata3 %>% group_by(ad_layer) %>% 
  summarise(n=n(), mean=mean(birth_rate), sd=sd(birth_rate)))
```

> 분산분석을 위한 가정 
>
> 1. 정규성 
>
> 2. 독립성   
>
> 3. 등분산성

```{r}
bartlett.test(mydata3$birth_rate~mydata3$ad_layer) #Bartlett 등분산성 검정

if(!require(car)) install.packages("car"); library(car)
leveneTest(mydata3$birth_rate~mydata3$ad_layer) # levene's 등분산성 검정
```
* 정규성 검정은 집단별로 shapiro.test로 확인 가능
* 표본의 수가 충분히 크다면 중심극한정리에 의해 정규성을 가정 후 분석 진행이 가능합니다.

```{r}
aov(mydata3$birth_rate~mydata3$ad_layer) # 종속변수 : birth_rate, 독립변수 : ad_layer
aov1 = aov(mydata3$birth_rate~mydata3$ad_layer) # 분산분석 결과를 aov1에 저장
aov1 = aov(birth_rate~ad_layer, data =mydata3) 

summary(aov1) #aov1 결과 출력 
```
* 만약 통계적으로 유의미한 차이가 있다면 사후 분석 실시

```{r, message=FALSE, warning=FALSE}
TukeyHSD(aov1) # aov1의 사후검정을 시행
out1<-TukeyHSD(aov1) # aov1의 사후검정을 시행
out1
plot(out1)
library(ggplot2)
if(!require(agricolae)) install.packages("agricolae"); library(agricolae)
out2<-LSD.test(aov1,"ad_layer",p.adj="bonferroni",group=F)
out2
out3<-LSD.test(aov1,"ad_layer",p.adj="bonferroni",group=T)
out3
plot(out3)
plot(out3, variation = "SD") #차이를 시각적으로 확인
```

* 등분산성을 만족하지 않으므로 위의 방법으로 분석하면 문제점 발생
```{r}
oneway1<-oneway.test(mydata3$birth_rate~mydata3$ad_layer)
oneway1<-oneway.test(birth_rate~ad_layer, data=mydata3)

oneway1
```
* 정규성을 만족하지 않는다면, 비모수방법이용
```{r}
kruskal1<-kruskal.test(mydata3$birth_rate~mydata3$ad_layer)
kruskal1<-kruskal.test(birth_rate~ad_layer, data=mydata3)

kruskal1
```